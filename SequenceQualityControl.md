# Sequence and quality control

Developed by: Henrique V. Figueiró

Contact: henriquevf@gmail.com

## Introduction

Next-generation sequencing (NGS) is a powerful tool for genomics research. However, it can generate raw data with errors or low-quality scores that can compromise downstream analyses. Therefore, it's crucial to evaluate the quality of the data before proceeding to more advanced stages of analysis.

In this tutorial, we will use FastQC for initial data quality check, AdapterRemoval for cleaning up the reads, and MultiQC for aggregating the results.

**FastQC** provides a simple way to do some quality control checks on raw sequence data (https://www.bioinformatics.babraham.ac.uk/projects/fastqc/).

**AdapterRemoval** searches for and removes remnant adapter sequences from High-Throughput Sequencing (HTS) data (https://adapterremoval.readthedocs.io/en/stable/).

**MultiQC** is a reporting tool that can visualize data across multiple tools and samples, providing a high-level overview of your dataset (https://multiqc.info/).

## 1. Quality Control with FastQC

### 1.1 Fastq file and phred score

A FASTQ file is a commonly used file format in genomics and sequencing studies to store both the DNA sequence and quality information. It consists of a series of records, each containing four lines of information. The first line begins with a "@" symbol and represents a unique identifier for the sequence. The second line contains the actual DNA sequence represented by a string of letters (A, T, C, and G) denoting the nucleotides. The third line is often marked with a "+" symbol and typically serves as a placeholder for additional information. Finally, the fourth line represents the quality scores associated with each base in the DNA sequence.

The Phred score is a metric used to quantify the quality of each base call in a FASTQ file. It measures the probability of an incorrect base call, with higher Phred scores indicating a lower probability of errors. The Phred score is logarithmically scaled and expressed as a numerical value. For example, a Phred score of 30 corresponds to an error probability of 1 in 1,000, while a score of 40 represents an error probability of 1 in 10,000. The quality scores help researchers assess the reliability of each base call and determine the confidence level in the accuracy of the sequenced data. By considering the Phred scores, researchers can make informed decisions about data filtering, variant calling, and other downstream analyses in genomics research.

### 1.2 FastQC

FastQC is a very useful tool that provides a quick and high-level overview of your sequencing data quality. It does this by generating a variety of plots, each of which tells you something different about your data. Here are the basic plots generated by FastQC:

1. **Basic Statistics**: This isn't a plot, but it's the first item in the FastQC report. It gives a general overview of your sequencing run, including the total sequences, sequence length, %GC content, etc.
2. **Per base sequence quality**: This plot shows the range of quality values across all bases at each position in the FASTQ file. In general, you want most of your bases to have high quality scores (above Q30).
3. **Per sequence quality scores**: This plot shows the distribution of average quality scores over all sequences in the read. It helps you to spot any systemic problems that occur over whole reads.
4. **Per base sequence content**: This shows the proportion of each base (A, T, C, G) at each position in the reads. For a random library, you'd expect that there would be little to no difference between the different bases, so a deviation from the expected equal proportion can indicate a sequencing bias.
5. **Per sequence GC content**: This shows the distribution of GC content over all sequences in the read as compared to a theoretical distribution. Significant deviation from the theoretical curve can indicate contamination, or a systematic bias.
6. **Per base N content**: This plot displays the percentage of base calls at each position for which an N was called (i.e. the base could not be determined).
7. **Sequence Length Distribution**: This shows how many sequences are of a certain length. In most sequencing procedures you'll get a uniform length distribution, so a change in this could suggest a library preparation issue.
8. **Sequence Duplication Levels**: This shows the relative level of duplication for every sequence in the library, which can be a sign of PCR amplification bias if there are a lot of duplicates.
9. **Overrepresented sequences**: A list of any sequences which make up more than 0.1% of the total. Can flag up issues like adapter contamination.
10. **Adapter Content**: Shows when a standard set of Illumina adapters are present at a given position in the reads. Can suggest if there is leftover adapter sequence present.
11. **Kmer Content**: Shows any overrepresented Kmers (short sequences of length 'k') in your data set, which can help identify contamination or bias.

Each of these plots will be marked as "pass" if FastQC thinks your data is okay in terms of this measure, "warn" if it might be a problem, and "fail" if there's definitely a problem.

### 

### 1.3 Running FastQC

Raw files are located:

```bash
/scratch/projects/hpc-workshop/clouded_leopard/raw_data
```

```bash
ls -lh

total 146G
-rw-r--r-- 1 hfigueiro hpc-workshop 17G Jun 21 09:46 NN114296_1.fastq.gz
-rw-r--r-- 1 hfigueiro hpc-workshop 18G Jun 21 09:46 NN114296_2.fastq.gz
-rw-r--r-- 1 hfigueiro hpc-workshop 16G Jun 21 09:46 NN114297_1.fastq.gz
-rw-r--r-- 1 hfigueiro hpc-workshop 16G Jun 21 09:46 NN114297_2.fastq.gz
-rw------- 1 hfigueiro hpc-workshop 13G Jun 21 09:50 NN114393_1.fastq.gz
-rw-r--r-- 1 hfigueiro hpc-workshop 13G Jun 21 09:49 NN114393_2.fastq.gz
-rw-r--r-- 1 hfigueiro hpc-workshop 15G Jun 21 09:49 NN115950_1.fastq.gz
-rw-r--r-- 1 hfigueiro hpc-workshop 15G Jun 21 09:49 NN115950_2.fastq.gz
-rw-r--r-- 1 hfigueiro hpc-workshop 13G Jun 21 09:50 NN190240_1.fastq.gz
-rw-r--r-- 1 hfigueiro hpc-workshop 14G Jun 21 09:49 NN190240_2.fastq.gz
```

On your user create the folder:

```bash
mkdir ~/clouded_leopard/
mkdir ~/clouded_leopard/fastqc_raw
mkdir ~/clouded_leopard/fastqc_trimmed
mkdir ~/clouded_leopard/fastq_trimmed
```

You can run FastQC on a single fastq file using the following command:

```
fastqc sample.fastq.gz -o ~/clouded_leopard/fastqc_raw

```

This will create a zipped HTML report which can be viewed in a web browser.

To run this command on the server we have available run the following command:

```bash
module load FastQC

srun --cpus-per-task=1 --mem=2G --time=1:00:00 fastqc /scratch/projects/hpc-workshop/clouded_leopard/raw_data/NN114393_*.fastq.gz -o ~/clouded_leopard/fastqc_raw/
```

```bash
-rw-r----- 1 hfigueiro guests 229K Jun 22 10:04 NN114393_2_fastqc.html
-rw-r----- 1 hfigueiro guests 793K Jun 22 10:04 NN114393_2_fastqc.zip
-rw-r----- 1 hfigueiro guests 227K Jun 22 09:44 NN114393_1_fastqc.html
-rw-r----- 1 hfigueiro guests 790K Jun 22 09:44 NN114393_1_fastqc.zip
```

Since we can't view the results on the terminal we need to download the results to our personal computers.

```bash
scp -r username@hpc-login.oakland.edu:~/clouded_leopard/fastqc_raw/*_fastqc.* /working/folder/on/laptop/
```

You can click the html file and see the results. After the quality control steps we are going to compare the before and after. 

## 2. Adapter removal with AdapterRemoval

AdapterRemoval can identify and remove adapter sequences from your reads. It can also remove low quality bases based on the phred score. It can handle both single-end and paired-end data.

During the preparation stage of DNA sequencing, it is common practice to attach adapters to both ends of the DNA fragment. This step is particularly important for short fragments, as it allows them to be effectively sequenced. However, it becomes crucial to remove these adapter sequences before proceeding with downstream analyses. The presence of these adapters can potentially introduce unwanted artifacts or errors that may interfere with accurate data interpretation. Therefore, thorough removal of the adapters ensures the integrity and reliability of the sequencing results, enabling more accurate downstream analyses and interpretation of the DNA sequence data.

### Commands

### 

### 2.1 Running AdapterRemoval

You can run AdapterRemoval on paired-end data as follows:

Change “SAMPLE_PREFIX” to the sample name your running

```
AdapterRemoval --file1 /scratch/projects/hpc-workshop/clouded_leopard/raw_data/SAMPLE_PREFIX_1.fastq.gz --file2 /scratch/projects/hpc-workshop/clouded_leopard/raw_data/SAMPLE_PREFIX_2.fastq.gz --basename ~/clouded_leopard/fastq_trimmed/SAMPLE_PREFIX --trimns --trimqualities --collapse --gzip

```

This will generate trimmed reads in "out.pair1.truncated" and "out.pair2.truncated", and the collapsed reads in "out.collapsed".

- `-file1`: Specifies the path to the first input file containing the sequencing data. This can be a single-end read file or the first file of a paired-end read.
- `-file2`: Specifies the path to the second input file containing the sequencing data. This is applicable only for paired-end reads.
- `-basename`: Sets the base name for the output files generated by AdapterRemoval. The output files will typically include both single-end and paired-end reads.
- `-trimns`: Removes trailing ambiguous bases (Ns) from the reads during processing. This is useful for cleaning up low-quality bases.
- `-trimqualities`: Trims low-quality bases from the reads based on their quality scores. This helps remove bases with low confidence.
- `-collapse`: Collapses identical reads into a single representative sequence. This reduces redundancy in the data and improves processing efficiency.
- `-gzip`: Specifies that the output files should be compressed using gzip. This results in compressed `.fastq.gz` files.

These parameters allow AdapterRemoval to preprocess and clean up sequencing data by removing adapters, trimming low-quality bases, and collapsing identical reads. The output files are typically in fastq format and can be compressed using gzip for efficient storage. Keep in mind that the specific usage and options of AdapterRemoval may vary depending on the version and configuration of the tool. It's always recommended to refer to the tool's documentation for detailed information on the parameters and their effects.

Here is an example on how to run it on the server: 

```bash
module load AdapterRemoval

srun --cpus-per-task=40 --mem=80G --time=3:00:00 AdapterRemoval --file1 /scratch/projects/hpc-workshop/clouded_leopard/raw_data/SAMPLE_PREFIX_1.fastq.gz --file2 /scratch/projects/hpc-workshop/clouded_leopard/raw_data/SAMPLE_PREFIX_2.fastq.gz --basename ~/clouded_leopard/fastq_trimmed/SAMPLE_PREFIX --trimns --trimqualities --collapse --gzip
```

Is advised to run fastqc again using the trimmed reads to compared with the raw data. The plots from fastqc should look better with less reads overall. 

```bash
module load FastQC

srun --cpus-per-task=10 --mem=8G --time=4:00:00 fastqc /scratch/users/YOUR_USER/clouded_leopard/fastq_trimmed/*.pair*.truncated.gz -o ~/clouded_leopard/fastqc_trimmed/

```

## 3. Aggregation with MultiQC

MultiQC collates results across many samples into a single report. It's a very useful tool to get an overview of the samples after performing quality control checks.

MultiQC collects results from other bioinformatics tools and compiles them into a single report. It can be used with a variety of bioinformatics tools, and it's capable of dealing with the output from tools used for quality control, alignment, quantification, and more.

To know all options the program has run the following command:

```bash
module load MultiQC

multiqc --help
```

### 3.1 Running MultiQC

After running FastQC and AdapterRemoval, you can generate a report with MultiQC as follows:

```
srun --cpus-per-task=1 --mem=4G --time=1:00:00 multiqc ~/clouded_leopard/fastqc_raw --outdir ~/clouded_leopard/ --filename clouded_leopard_raw
srun --cpus-per-task=1 --mem=4G --time=1:00:00 multiqc ~/clouded_leopard/fastqc_trimmed --outdir ~/clouded_leopard/ --filename clouded_leopard_trimmed

```

This command will search for all recognized report files in the current directory and compile them into a single HTML report.

To copy the files to your machine use the following command

```bash
scp -r USERNAME@hpc-login.oakland.edu:~/clouded_leopard/clouded_leopard_raw.html /working/folder/on/laptop/
```

FastQC, AdapterRemoval, and MultiQC are powerful tools for the preprocessing and quality control of sequencing data. They are crucial steps in NGS data analysis pipelines to ensure the reliability and accuracy of downstream analyses. There are several other tools that can remove adapters and bad quality reads, in the end you should choose the one that best address your question or are available to you.
